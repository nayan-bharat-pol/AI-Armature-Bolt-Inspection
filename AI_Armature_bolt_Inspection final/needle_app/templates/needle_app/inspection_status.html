{% extends 'needle_app/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4><i class="bi bi-camera"></i> Live Inspection Status</h4>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h5>Armature Bolt</h5>
                            </div>
                            <div class="card-body text-center">
                                <img id="needle1Image" src="/static/placeholder.jpg" class="img-fluid rounded" alt="Armature
Bolt" style="max-height: 400px; background: #f0f0f0;">
                                <div class="mt-3">
                                    <span id="needle1Status" class="status-badge bg-secondary text-white">Waiting...</span>
                                </div>
                                <div id="needle1Defects" class="mt-2 text-danger"></div>
                            </div>
                        </div>
                    </div> 
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-danger btn-lg" id="endBtn">
                        <i class="bi bi-stop-circle"></i> End Inspection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Poll for new images every 2 seconds
let pollInterval = setInterval(fetchNeedleImages, 2000);

function fetchNeedleImages() {
    fetch('{% url "needle_app:get_needle_images" %}')
        .then(response => response.json())
        .then(data => {
            // Update Needle 1
            document.getElementById('needle1Image').src = data.needle1.image_url;
            const status1 = document.getElementById('needle1Status');
            status1.textContent = data.needle1.status;
            status1.className = 'status-badge ' + (data.needle1.status === 'OK' ? 'bg-success' : 'bg-danger') + ' text-white';
            
            if(data.needle1.defects.length > 0) {
                document.getElementById('needle1Defects').innerHTML = '<strong>Defects:</strong> ' + data.needle1.defects.join(', ');
            }
            
            
        });
}

document.getElementById('endBtn').addEventListener('click', function() {
    if(confirm('Are you sure you want to end the inspection?')) {
        clearInterval(pollInterval);
        fetch('{% url "needle_app:end_inspection" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.href = '{% url "needle_app:home" %}';
        });
    }
});
</script>
{% endblock %}